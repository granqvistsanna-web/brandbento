---
phase: 04-color-imagery-tiles
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/components/filters/DuotoneFilter.tsx
  - src/components/filters/GrainFilter.tsx
  - src/components/filters/TreatmentFilter.tsx
  - src/components/pickers/TreatmentPresets.tsx
  - src/utils/imageFilters.ts
  - src/components/tiles/ImageryTile.tsx
autonomous: true

must_haves:
  truths:
    - "Image treatment presets are available (Original, Duotone, B&W, Hi-contrast, Soft, Grain)"
    - "Duotone maps image to primary + background brand colors"
    - "Hovering a treatment preset previews it instantly"
    - "Treatment thumbnails show current image with filter applied"
  artifacts:
    - path: "src/components/filters/DuotoneFilter.tsx"
      provides: "Duotone effect using CSS mix-blend-mode"
      exports: ["DuotoneFilter"]
    - path: "src/components/filters/GrainFilter.tsx"
      provides: "SVG feTurbulence grain overlay"
      exports: ["GrainFilter"]
    - path: "src/components/filters/TreatmentFilter.tsx"
      provides: "Unified filter wrapper applying all treatments"
      exports: ["TreatmentFilter"]
    - path: "src/components/pickers/TreatmentPresets.tsx"
      provides: "Preset buttons with hover preview and thumbnails"
      exports: ["TreatmentPresets"]
  key_links:
    - from: "src/components/filters/DuotoneFilter.tsx"
      to: "CSS mix-blend-mode"
      via: "darken + lighten blend modes"
      pattern: "mixBlendMode"
    - from: "src/components/filters/GrainFilter.tsx"
      to: "SVG feTurbulence"
      via: "SVG filter for noise generation"
      pattern: "feTurbulence"
---

<objective>
Build image treatment presets with duotone (using brand colors), grayscale, high-contrast, soft, and grain effects. Hover previews treatments instantly.

Purpose: Users can apply artistic treatments to their brand imagery that tie into the overall brand palette, especially duotone which uses primary + background colors.
Output: Treatment components and preset picker with thumbnails and hover preview.
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-color-imagery-tiles/04-RESEARCH.md
@.planning/phases/04-color-imagery-tiles/04-02-SUMMARY.md
@.planning/phases/04-color-imagery-tiles/04-03-SUMMARY.md

# Components from prior plans
@src/components/tiles/ImageryTile.tsx
@src/hooks/useHoverPreview.ts
@src/state/canvasState.ts
@src/types/brand.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image filter utilities and base components</name>
  <files>
    src/utils/imageFilters.ts
    src/components/filters/DuotoneFilter.tsx
    src/components/filters/GrainFilter.tsx
  </files>
  <action>
1. Create `src/utils/imageFilters.ts` with CSS filter strings:
   ```typescript
   import type { ImageTreatment } from '@/types/brand';

   export interface TreatmentInfo {
     name: ImageTreatment;
     label: string;
     filter: string;  // CSS filter string (empty for component-based)
     usesComponent: boolean;  // true for duotone, grain
   }

   export const TREATMENTS: TreatmentInfo[] = [
     {
       name: 'original',
       label: 'Original',
       filter: 'none',
       usesComponent: false,
     },
     {
       name: 'duotone',
       label: 'Duotone',
       filter: 'grayscale(100%)',  // Base filter, component adds color
       usesComponent: true,
     },
     {
       name: 'bw',
       label: 'B&W',
       filter: 'grayscale(100%)',
       usesComponent: false,
     },
     {
       name: 'hi-contrast',
       label: 'Hi-Contrast',
       filter: 'contrast(1.3) saturate(1.2) brightness(1.05)',
       usesComponent: false,
     },
     {
       name: 'soft',
       label: 'Soft',
       filter: 'contrast(0.85) saturate(0.9) brightness(1.1)',
       usesComponent: false,
     },
     {
       name: 'grain',
       label: 'Grain',
       filter: 'none',  // Applied via SVG filter
       usesComponent: true,
     },
   ];

   export function getTreatmentFilter(treatment: ImageTreatment): string {
     const info = TREATMENTS.find(t => t.name === treatment);
     return info?.filter || 'none';
   }

   export function treatmentUsesComponent(treatment: ImageTreatment): boolean {
     const info = TREATMENTS.find(t => t.name === treatment);
     return info?.usesComponent || false;
   }
   ```

2. Create `src/components/filters/DuotoneFilter.tsx`:
   ```typescript
   import type { ColorPalette } from '@/types/brand';

   interface DuotoneFilterProps {
     children: React.ReactNode;
     palette: ColorPalette;
   }

   /**
    * Duotone effect using CSS mix-blend-mode.
    * Maps image shadows to background color, highlights to primary color.
    */
   export function DuotoneFilter({ children, palette }: DuotoneFilterProps) {
     return (
       <div
         className="relative w-full h-full"
         style={{ backgroundColor: palette.background }}
       >
         {/* Image with grayscale + darken blend */}
         <div
           className="w-full h-full"
           style={{
             filter: 'grayscale(100%) contrast(1)',
             mixBlendMode: 'darken',
           }}
         >
           {children}
         </div>

         {/* Primary color overlay with lighten blend */}
         <div
           className="absolute inset-0 pointer-events-none"
           style={{
             backgroundColor: palette.primary,
             mixBlendMode: 'lighten',
           }}
         />
       </div>
     );
   }
   ```

3. Create `src/components/filters/GrainFilter.tsx`:
   ```typescript
   import { useId } from 'react';

   interface GrainFilterProps {
     children: React.ReactNode;
     intensity?: number;  // 0-1
   }

   /**
    * Film grain effect using SVG feTurbulence filter.
    * More performant than PNG textures, scalable, no network request.
    */
   export function GrainFilter({ children, intensity = 0.5 }: GrainFilterProps) {
     const filterId = useId();

     return (
       <div className="relative w-full h-full">
         {/* SVG filter definition */}
         <svg className="absolute w-0 h-0" aria-hidden="true">
           <defs>
             <filter id={filterId}>
               {/* Generate Perlin noise */}
               <feTurbulence
                 type="fractalNoise"
                 baseFrequency="0.8"
                 numOctaves="4"
                 stitchTiles="stitch"
                 result="noise"
               />
               {/* Desaturate noise */}
               <feColorMatrix
                 in="noise"
                 type="saturate"
                 values="0"
                 result="desaturated"
               />
               {/* Control intensity via opacity */}
               <feComponentTransfer in="desaturated" result="adjusted">
                 <feFuncA type="linear" slope={intensity} intercept="0" />
               </feComponentTransfer>
               {/* Blend with source using multiply */}
               <feBlend mode="multiply" in="adjusted" in2="SourceGraphic" />
             </filter>
           </defs>
         </svg>

         {/* Apply filter to children */}
         <div
           className="w-full h-full"
           style={{ filter: `url(#${filterId})` }}
         >
           {children}
         </div>
       </div>
     );
   }
   ```
  </action>
  <verify>
    `npx tsc --noEmit` passes
    DuotoneFilter renders with grayscale + blend modes
    GrainFilter generates unique SVG filter ID per instance
  </verify>
  <done>
    Image filter utilities defined. DuotoneFilter uses mix-blend-mode. GrainFilter uses SVG feTurbulence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unified treatment filter and preset picker</name>
  <files>
    src/components/filters/TreatmentFilter.tsx
    src/components/pickers/TreatmentPresets.tsx
  </files>
  <action>
1. Create `src/components/filters/TreatmentFilter.tsx`:
   ```typescript
   import type { ImageTreatment, ColorPalette } from '@/types/brand';
   import { getTreatmentFilter, treatmentUsesComponent } from '@/utils/imageFilters';
   import { DuotoneFilter } from './DuotoneFilter';
   import { GrainFilter } from './GrainFilter';

   interface TreatmentFilterProps {
     treatment: ImageTreatment;
     palette: ColorPalette;
     colorOverlay?: number;  // 0-60 percentage
     children: React.ReactNode;
   }

   /**
    * Unified component that applies the selected image treatment.
    * Handles both CSS filter treatments and component-based treatments.
    */
   export function TreatmentFilter({
     treatment,
     palette,
     colorOverlay = 0,
     children,
   }: TreatmentFilterProps) {
     // Apply component-based treatments
     if (treatment === 'duotone') {
       return (
         <DuotoneFilter palette={palette}>
           {children}
         </DuotoneFilter>
       );
     }

     if (treatment === 'grain') {
       return (
         <GrainFilter intensity={0.4}>
           <div className="w-full h-full">{children}</div>
         </GrainFilter>
       );
     }

     // CSS filter-based treatments
     const filterStyle = getTreatmentFilter(treatment);

     return (
       <div className="relative w-full h-full">
         {/* Image with CSS filter */}
         <div
           className="w-full h-full"
           style={{ filter: filterStyle }}
         >
           {children}
         </div>

         {/* Color overlay (IMGR-06) */}
         {colorOverlay > 0 && (
           <div
             className="absolute inset-0 pointer-events-none"
             style={{
               backgroundColor: palette.primary,
               opacity: colorOverlay / 100,
             }}
           />
         )}
       </div>
     );
   }
   ```

2. Create `src/components/pickers/TreatmentPresets.tsx`:
   ```typescript
   import { useCanvasStore } from '@/state/canvasState';
   import { useHoverPreview } from '@/hooks/useHoverPreview';
   import { TREATMENTS, type TreatmentInfo } from '@/utils/imageFilters';
   import { TreatmentFilter } from '@/components/filters/TreatmentFilter';
   import type { ImageTreatment } from '@/types/brand';

   interface TreatmentPresetsProps {
     onClose?: () => void;
   }

   export function TreatmentPresets({ onClose }: TreatmentPresetsProps) {
     const heroImage = useCanvasStore(state => state.assets.heroImage);
     const palette = useCanvasStore(state => state.assets.palette);
     const currentTreatment = useCanvasStore(state => state.assets.imagery.treatment);
     const setImageTreatment = useCanvasStore(state => state.setImageTreatment);

     const { activeValue, onHoverStart, onHoverEnd, isPreviewActive } = useHoverPreview(currentTreatment);

     // Apply preview treatment temporarily
     const handleHover = (treatment: ImageTreatment) => {
       onHoverStart(treatment);
       // Directly update store for live preview
       setImageTreatment(treatment);
     };

     const handleHoverEnd = () => {
       // Revert to committed value
       setImageTreatment(currentTreatment);
       onHoverEnd();
     };

     const handleClick = (treatment: ImageTreatment) => {
       setImageTreatment(treatment);
       onClose?.();
     };

     // Don't show presets if no image
     if (!heroImage) {
       return (
         <div className="text-sm text-gray-400 italic">
           Upload an image to see treatment presets
         </div>
       );
     }

     return (
       <div className="space-y-3">
         <span className="text-xs text-gray-500 uppercase tracking-wide">
           Treatments
         </span>

         <div className="grid grid-cols-3 gap-2">
           {TREATMENTS.map((treatment) => (
             <TreatmentThumbnail
               key={treatment.name}
               treatment={treatment}
               heroImage={heroImage}
               palette={palette}
               isSelected={currentTreatment === treatment.name}
               onMouseEnter={() => handleHover(treatment.name)}
               onMouseLeave={handleHoverEnd}
               onClick={() => handleClick(treatment.name)}
             />
           ))}
         </div>
       </div>
     );
   }

   interface TreatmentThumbnailProps {
     treatment: TreatmentInfo;
     heroImage: string;
     palette: {
       primary: string;
       accent: string;
       background: string;
       text: string;
     };
     isSelected: boolean;
     onMouseEnter: () => void;
     onMouseLeave: () => void;
     onClick: () => void;
   }

   function TreatmentThumbnail({
     treatment,
     heroImage,
     palette,
     isSelected,
     onMouseEnter,
     onMouseLeave,
     onClick,
   }: TreatmentThumbnailProps) {
     return (
       <button
         onMouseEnter={onMouseEnter}
         onMouseLeave={onMouseLeave}
         onClick={onClick}
         className={`
           group flex flex-col items-center gap-1 p-1 rounded-lg
           transition-all duration-150
           ${isSelected ? 'ring-2 ring-blue-500 ring-offset-1' : 'hover:bg-gray-100'}
         `}
       >
         {/* Thumbnail with filter applied */}
         <div className="w-16 h-12 rounded overflow-hidden bg-gray-100">
           <TreatmentFilter
             treatment={treatment.name}
             palette={palette}
           >
             <img
               src={heroImage}
               alt={treatment.label}
               className="w-full h-full object-cover"
             />
           </TreatmentFilter>
         </div>

         <span className={`
           text-[10px] transition-colors
           ${isSelected ? 'text-blue-600 font-medium' : 'text-gray-500 group-hover:text-gray-700'}
         `}>
           {treatment.label}
         </span>
       </button>
     );
   }
   ```
  </action>
  <verify>
    `npx tsc --noEmit` passes
    TreatmentFilter applies correct effect for each treatment type
    TreatmentPresets shows 6 thumbnails with current image
    Hovering thumbnail previews treatment on main image
  </verify>
  <done>
    TreatmentFilter wraps image with selected effect. TreatmentPresets shows thumbnails with hover preview.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate treatments into ImageryTile</name>
  <files>
    src/components/tiles/ImageryTile.tsx
  </files>
  <action>
Update `src/components/tiles/ImageryTile.tsx` to include treatment filter and presets:

```typescript
import { useState } from 'react';
import { useCanvasStore } from '@/state/canvasState';
import { GradientFallback } from '@/components/controls/GradientFallback';
import { ImageUpload } from '@/components/controls/ImageUpload';
import { TreatmentFilter } from '@/components/filters/TreatmentFilter';
import { TreatmentPresets } from '@/components/pickers/TreatmentPresets';

interface ImageryTileProps {
  className?: string;
  isEditing?: boolean;
  onEditToggle?: (editing: boolean) => void;
}

export function ImageryTile({
  className = '',
  isEditing = false,
  onEditToggle,
}: ImageryTileProps) {
  const heroImage = useCanvasStore(state => state.assets.heroImage);
  const imagesSource = useCanvasStore(state => state.assets.imagesSource);
  const palette = useCanvasStore(state => state.assets.palette);
  const imagery = useCanvasStore(state => state.assets.imagery);

  const hasImage = !!heroImage;
  const isDefault = imagesSource === 'default';

  const handleEditClose = () => {
    onEditToggle?.(false);
  };

  return (
    <div className={`relative overflow-hidden ${className}`}>
      {/* Image/Gradient with treatment applied */}
      {hasImage ? (
        <TreatmentFilter
          treatment={imagery.treatment}
          palette={palette}
          colorOverlay={imagery.colorOverlay}
        >
          <img
            src={heroImage}
            alt="Brand imagery"
            className="w-full h-full object-cover"
            loading="lazy"
          />
        </TreatmentFilter>
      ) : (
        <GradientFallback />
      )}

      {/* Default indicator */}
      {isDefault && !hasImage && (
        <div className="absolute bottom-2 left-2 text-xs text-white/70 bg-black/30 px-2 py-0.5 rounded">
          Default - click to change
        </div>
      )}

      {/* Upload overlay (always present, shown on hover) */}
      <ImageUpload className="absolute inset-0" />

      {/* Treatment presets panel (shown in edit mode) */}
      {isEditing && hasImage && (
        <div className="absolute bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-sm border-t border-gray-200">
          <TreatmentPresets onClose={handleEditClose} />
        </div>
      )}

      {/* Treatment indicator when not editing */}
      {hasImage && imagery.treatment !== 'original' && !isEditing && (
        <div className="absolute top-2 right-2 text-xs text-white bg-black/40 px-2 py-0.5 rounded">
          {imagery.treatment.charAt(0).toUpperCase() + imagery.treatment.slice(1)}
        </div>
      )}
    </div>
  );
}
```

Key changes:
1. TreatmentFilter wraps image to apply selected treatment
2. TreatmentPresets panel shown when editing
3. Treatment indicator badge shows current effect name
4. Color overlay support for semi-transparent wash
  </action>
  <verify>
    `npx tsc --noEmit` passes
    ImageryTile applies treatment filter to image
    Hovering preset thumbnail updates main image instantly
    Clicking preset commits treatment
    Treatment indicator shows when not original
  </verify>
  <done>
    ImageryTile integrates treatment filter and preset picker. Hover previews work. Duotone uses brand colors.
  </done>
</task>

</tasks>

<verification>
1. Types compile: `npx tsc --noEmit` passes
2. Treatments work:
   - Original: No filter applied
   - Duotone: Grayscale with primary/background blend (IMGR-05)
   - B&W: grayscale(100%)
   - Hi-Contrast: contrast(1.3) saturate(1.2) brightness(1.05)
   - Soft: contrast(0.85) saturate(0.9) brightness(1.1)
   - Grain: SVG feTurbulence noise overlay
3. Thumbnails: Each preset shows current image with filter applied (IMGR-08)
4. Hover preview: Hovering thumbnail instantly previews on main image (IMGR-07)
5. Duotone colors: Uses palette.primary for highlights, palette.background for shadows
6. Performance: CSS filters and mix-blend-mode are GPU-accelerated (no jank)
</verification>

<success_criteria>
- 6 treatment presets available (IMGR-04)
- DuotoneFilter maps to primary + background colors (IMGR-05)
- GrainFilter uses SVG feTurbulence (no PNG texture)
- TreatmentPresets shows thumbnails with filter applied (IMGR-08)
- Hovering preset previews instantly (IMGR-07)
- Clicking preset commits to store
- ImageryTile applies treatment filter to displayed image
- Treatment indicator shows current effect name
</success_criteria>

<output>
After completion, create `.planning/phases/04-color-imagery-tiles/04-04-SUMMARY.md`
</output>
