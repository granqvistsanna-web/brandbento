---
phase: 04-color-imagery-tiles
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/tiles/ColorTile.tsx
  - src/components/pickers/ColorPicker.tsx
  - src/components/controls/ColorSwatch.tsx
  - src/components/controls/ContrastBadge.tsx
  - src/components/controls/RoleDropdown.tsx
  - src/components/pickers/PalettePresets.tsx
  - src/hooks/useHoverPreview.ts
autonomous: true

must_haves:
  truths:
    - "Color palette displays swatches stacked by role with hex values"
    - "WCAG contrast check is always visible on the tile"
    - "Clicking a swatch opens HSL color picker with hue ring and HEX input"
    - "Dragging picker updates canvas continuously under 50ms"
    - "Hovering preset temporarily applies entire palette across canvas"
    - "User can reassign color roles via dropdown"
  artifacts:
    - path: "src/components/tiles/ColorTile.tsx"
      provides: "Color palette tile with swatches and contrast badge"
      exports: ["ColorTile"]
    - path: "src/components/pickers/ColorPicker.tsx"
      provides: "HSL picker with continuous rAF updates"
      exports: ["ColorPicker"]
    - path: "src/components/pickers/PalettePresets.tsx"
      provides: "Preset buttons with hover preview"
      exports: ["PalettePresets"]
    - path: "src/hooks/useHoverPreview.ts"
      provides: "Hover preview pattern hook"
      exports: ["useHoverPreview"]
  key_links:
    - from: "src/components/pickers/ColorPicker.tsx"
      to: "react-colorful"
      via: "HslColorPicker component"
      pattern: "HslColorPicker"
    - from: "src/components/pickers/ColorPicker.tsx"
      to: "requestAnimationFrame"
      via: "rAF throttling for sub-50ms updates"
      pattern: "requestAnimationFrame"
---

<objective>
Build the complete color tile with swatch display, HSL color picker, contrast checking, palette presets with hover preview, and role reassignment.

Purpose: Users can customize colors with WCAG contrast checking, live preview during picking, and preset variations. This is the core color customization experience.
Output: ColorTile component with all sub-components (swatches, picker, presets, role dropdown).
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-color-imagery-tiles/04-RESEARCH.md
@.planning/phases/04-color-imagery-tiles/04-01-SUMMARY.md

# Utilities from Plan 01
@src/utils/colorContrast.ts
@src/utils/colorConversion.ts
@src/utils/paletteGenerator.ts
@src/state/canvasState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useHoverPreview hook and base components</name>
  <files>
    src/hooks/useHoverPreview.ts
    src/components/controls/ColorSwatch.tsx
    src/components/controls/ContrastBadge.tsx
  </files>
  <action>
1. Create `src/hooks/useHoverPreview.ts` for temporary preview pattern:
   ```typescript
   import { useState, useCallback } from 'react';

   interface UseHoverPreviewResult<T> {
     activeValue: T;
     isPreviewActive: boolean;
     onHoverStart: (value: T) => void;
     onHoverEnd: () => void;
   }

   /**
    * Hook for hover preview pattern - shows temporary value on hover,
    * reverts on mouse leave. Used for palette presets, treatment presets.
    */
   export function useHoverPreview<T>(committedValue: T): UseHoverPreviewResult<T> {
     const [previewValue, setPreviewValue] = useState<T | null>(null);

     const onHoverStart = useCallback((value: T) => {
       setPreviewValue(value);
     }, []);

     const onHoverEnd = useCallback(() => {
       setPreviewValue(null);
     }, []);

     return {
       activeValue: previewValue ?? committedValue,
       isPreviewActive: previewValue !== null,
       onHoverStart,
       onHoverEnd,
     };
   }
   ```

2. Create `src/components/controls/ColorSwatch.tsx`:
   ```typescript
   import { getContrastTextColor } from '@/utils/colorContrast';
   import type { ColorPalette } from '@/types/brand';

   interface ColorSwatchProps {
     color: string;
     role: keyof ColorPalette;
     label: string;
     isSelected?: boolean;
     onClick?: () => void;
   }

   const ROLE_LABELS: Record<keyof ColorPalette, string> = {
     primary: 'Primary',
     accent: 'Accent',
     background: 'Background',
     text: 'Text',
   };

   export function ColorSwatch({
     color,
     role,
     label,
     isSelected = false,
     onClick,
   }: ColorSwatchProps) {
     const textColor = getContrastTextColor(color);

     return (
       <button
         onClick={onClick}
         className={`
           w-full h-12 px-3 flex items-center justify-between
           rounded-md transition-all duration-150
           ${isSelected ? 'ring-2 ring-offset-2 ring-blue-500' : ''}
         `}
         style={{ backgroundColor: color, color: textColor }}
         aria-label={`${ROLE_LABELS[role]}: ${color}`}
       >
         <span className="text-xs font-medium opacity-80">
           {ROLE_LABELS[role]}
         </span>
         <span className="text-xs font-mono uppercase">
           {color}
         </span>
       </button>
     );
   }
   ```

3. Create `src/components/controls/ContrastBadge.tsx`:
   ```typescript
   import { checkContrast, type ContrastResult } from '@/utils/colorContrast';
   import type { ColorPalette } from '@/types/brand';

   interface ContrastBadgeProps {
     palette: ColorPalette;
   }

   export function ContrastBadge({ palette }: ContrastBadgeProps) {
     // Check text on background (primary contrast pair)
     const result = checkContrast(palette.text, palette.background);

     const getBadgeStyles = (level: ContrastResult['level']) => {
       switch (level) {
         case 'AAA':
           return 'bg-green-100 text-green-800 border-green-200';
         case 'AA':
           return 'bg-yellow-100 text-yellow-800 border-yellow-200';
         case 'fail':
           return 'bg-red-100 text-red-800 border-red-200';
       }
     };

     return (
       <div
         className={`
           inline-flex items-center gap-1.5 px-2 py-1 rounded-full
           text-xs font-medium border
           ${getBadgeStyles(result.level)}
         `}
         title={`Contrast ratio: ${result.ratio}:1`}
       >
         <span>{result.ratio}:1</span>
         <span className="font-semibold">
           {result.level === 'fail' ? 'Low' : result.level}
         </span>
         {result.level === 'fail' && (
           <span className="text-[10px]" title="Text may be hard to read">
             (warning)
           </span>
         )}
       </div>
     );
   }
   ```
  </action>
  <verify>
    `npx tsc --noEmit` passes
    Components render without errors in isolation
  </verify>
  <done>
    useHoverPreview hook created. ColorSwatch shows role + hex. ContrastBadge shows AA/AAA with color-coded indicator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create color picker with continuous updates</name>
  <files>
    src/components/pickers/ColorPicker.tsx
    src/components/controls/RoleDropdown.tsx
  </files>
  <action>
1. Create `src/components/pickers/ColorPicker.tsx` with rAF throttling:
   ```typescript
   import { HslColorPicker, HexColorInput } from 'react-colorful';
   import { useRef, useCallback, useEffect, useState } from 'react';
   import { useCanvasStore } from '@/state/canvasState';
   import { hexToHsl, hslToHex, type HslColor } from '@/utils/colorConversion';
   import { ContrastBadge } from '@/components/controls/ContrastBadge';
   import { RoleDropdown } from '@/components/controls/RoleDropdown';
   import type { ColorPalette } from '@/types/brand';

   interface ColorPickerProps {
     colorRole: keyof ColorPalette;
     onClose: () => void;
     onRoleChange?: (newRole: keyof ColorPalette) => void;
   }

   export function ColorPicker({ colorRole, onClose, onRoleChange }: ColorPickerProps) {
     const palette = useCanvasStore(state => state.assets.palette);
     const setColorByRole = useCanvasStore(state => state.setColorByRole);

     const currentColor = palette[colorRole];
     const [localHsl, setLocalHsl] = useState<HslColor>(hexToHsl(currentColor));

     // Use ref for continuous updates to avoid re-render overhead
     const rafRef = useRef<number | null>(null);
     const latestColorRef = useRef<HslColor>(localHsl);

     const handleChange = useCallback((color: HslColor) => {
       latestColorRef.current = color;
       setLocalHsl(color); // Update local display

       // Cancel pending frame
       if (rafRef.current !== null) {
         cancelAnimationFrame(rafRef.current);
       }

       // Schedule update on next frame (throttled to 60fps = ~16.67ms)
       rafRef.current = requestAnimationFrame(() => {
         const hex = hslToHex(latestColorRef.current);
         setColorByRole(colorRole, hex);
         rafRef.current = null;
       });
     }, [colorRole, setColorByRole]);

     const handleHexChange = useCallback((hex: string) => {
       const hsl = hexToHsl(hex);
       handleChange(hsl);
     }, [handleChange]);

     // Cleanup on unmount
     useEffect(() => {
       return () => {
         if (rafRef.current !== null) {
           cancelAnimationFrame(rafRef.current);
         }
       };
     }, []);

     // Sync local state when role changes
     useEffect(() => {
       setLocalHsl(hexToHsl(palette[colorRole]));
       latestColorRef.current = hexToHsl(palette[colorRole]);
     }, [colorRole, palette]);

     return (
       <div className="p-4 bg-white rounded-lg shadow-lg border border-gray-200 w-64">
         <div className="flex items-center justify-between mb-3">
           <RoleDropdown
             currentRole={colorRole}
             onChange={onRoleChange}
           />
           <button
             onClick={onClose}
             className="p-1 hover:bg-gray-100 rounded"
             aria-label="Close picker"
           >
             <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
             </svg>
           </button>
         </div>

         {/* HSL Color Picker (hue ring + saturation/lightness square) */}
         <div className="mb-4">
           <HslColorPicker
             color={localHsl}
             onChange={handleChange}
             style={{ width: '100%' }}
           />
         </div>

         {/* HEX Input */}
         <div className="mb-4">
           <label className="block text-xs text-gray-500 mb-1">HEX</label>
           <HexColorInput
             color={hslToHex(localHsl)}
             onChange={handleHexChange}
             prefixed
             className="w-full px-3 py-2 border border-gray-200 rounded text-sm font-mono uppercase"
           />
         </div>

         {/* Contrast indicator */}
         <div className="flex justify-center">
           <ContrastBadge palette={palette} />
         </div>
       </div>
     );
   }
   ```

2. Create `src/components/controls/RoleDropdown.tsx`:
   ```typescript
   import type { ColorPalette } from '@/types/brand';

   interface RoleDropdownProps {
     currentRole: keyof ColorPalette;
     onChange?: (role: keyof ColorPalette) => void;
   }

   const ROLES: { value: keyof ColorPalette; label: string }[] = [
     { value: 'primary', label: 'Primary' },
     { value: 'accent', label: 'Accent' },
     { value: 'background', label: 'Background' },
     { value: 'text', label: 'Text' },
   ];

   export function RoleDropdown({ currentRole, onChange }: RoleDropdownProps) {
     if (!onChange) {
       // Display-only mode
       return (
         <span className="text-sm font-medium text-gray-700">
           {ROLES.find(r => r.value === currentRole)?.label}
         </span>
       );
     }

     return (
       <select
         value={currentRole}
         onChange={(e) => onChange(e.target.value as keyof ColorPalette)}
         className="text-sm font-medium text-gray-700 bg-transparent border-none focus:ring-2 focus:ring-blue-500 rounded cursor-pointer"
       >
         {ROLES.map(({ value, label }) => (
           <option key={value} value={value}>
             {label}
           </option>
         ))}
       </select>
     );
   }
   ```
  </action>
  <verify>
    `npx tsc --noEmit` passes
    ColorPicker renders with HslColorPicker from react-colorful
    Dragging updates store via rAF (check DevTools Performance - no dropped frames)
  </verify>
  <done>
    ColorPicker uses rAF for sub-50ms updates during drag. HEX input allows direct entry. RoleDropdown enables reassignment.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create palette presets and complete ColorTile</name>
  <files>
    src/components/pickers/PalettePresets.tsx
    src/components/tiles/ColorTile.tsx
  </files>
  <action>
1. Create `src/components/pickers/PalettePresets.tsx`:
   ```typescript
   import { useCanvasStore } from '@/state/canvasState';
   import { useHoverPreview } from '@/hooks/useHoverPreview';
   import { PALETTE_PRESETS, type PalettePresetName } from '@/utils/paletteGenerator';
   import type { ColorPalette } from '@/types/brand';
   import { useEffect } from 'react';

   interface PalettePresetsProps {
     baseColors: string[];
   }

   export function PalettePresets({ baseColors }: PalettePresetsProps) {
     const currentPalette = useCanvasStore(state => state.assets.palette);
     const setPalette = useCanvasStore(state => state.setPalette);
     const { activeValue, onHoverStart, onHoverEnd, isPreviewActive } = useHoverPreview(currentPalette);

     // Apply preview palette to canvas temporarily
     useEffect(() => {
       if (isPreviewActive) {
         // Temporarily update store for preview
         setPalette(activeValue);
       }
     }, [activeValue, isPreviewActive, setPalette]);

     // Revert on unmount if preview was active
     useEffect(() => {
       return () => {
         if (isPreviewActive) {
           setPalette(currentPalette);
         }
       };
     }, []);

     const handleHover = (presetName: PalettePresetName) => {
       const preset = PALETTE_PRESETS.find(p => p.name === presetName);
       if (preset) {
         const generatedPalette = preset.generate(baseColors);
         onHoverStart(generatedPalette);
       }
     };

     const handleClick = (presetName: PalettePresetName) => {
       const preset = PALETTE_PRESETS.find(p => p.name === presetName);
       if (preset) {
         const generatedPalette = preset.generate(baseColors);
         setPalette(generatedPalette);
       }
     };

     return (
       <div className="flex flex-wrap gap-2">
         {PALETTE_PRESETS.map((preset) => {
           const generated = preset.generate(baseColors);

           return (
             <button
               key={preset.name}
               onMouseEnter={() => handleHover(preset.name)}
               onMouseLeave={onHoverEnd}
               onClick={() => handleClick(preset.name)}
               className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-gray-100 transition-colors"
               title={preset.label}
             >
               {/* Mini color swatch preview */}
               <div className="flex gap-0.5">
                 {Object.values(generated).map((color, i) => (
                   <div
                     key={i}
                     className="w-4 h-4 rounded-sm first:rounded-l last:rounded-r"
                     style={{ backgroundColor: color }}
                   />
                 ))}
               </div>
               <span className="text-[10px] text-gray-500 group-hover:text-gray-700">
                 {preset.label}
               </span>
             </button>
           );
         })}
       </div>
     );
   }
   ```

2. Create `src/components/tiles/ColorTile.tsx`:
   ```typescript
   import { useState } from 'react';
   import { useCanvasStore } from '@/state/canvasState';
   import { ColorSwatch } from '@/components/controls/ColorSwatch';
   import { ContrastBadge } from '@/components/controls/ContrastBadge';
   import { ColorPicker } from '@/components/pickers/ColorPicker';
   import { PalettePresets } from '@/components/pickers/PalettePresets';
   import type { ColorPalette } from '@/types/brand';

   const ROLE_ORDER: (keyof ColorPalette)[] = ['primary', 'accent', 'background', 'text'];

   export function ColorTile() {
     const palette = useCanvasStore(state => state.assets.palette);
     const colors = useCanvasStore(state => state.assets.colors);
     const [selectedRole, setSelectedRole] = useState<keyof ColorPalette | null>(null);

     const handleSwatchClick = (role: keyof ColorPalette) => {
       setSelectedRole(role === selectedRole ? null : role);
     };

     const handleClosePickler = () => {
       setSelectedRole(null);
     };

     const handleRoleChange = (newRole: keyof ColorPalette) => {
       setSelectedRole(newRole);
     };

     return (
       <div className="h-full flex flex-col p-4">
         {/* Always visible contrast badge */}
         <div className="flex justify-between items-center mb-3">
           <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">
             Colors
           </span>
           <ContrastBadge palette={palette} />
         </div>

         {/* Color swatches stacked by role */}
         <div className="flex-1 flex flex-col gap-2">
           {ROLE_ORDER.map((role) => (
             <ColorSwatch
               key={role}
               color={palette[role]}
               role={role}
               label={role}
               isSelected={selectedRole === role}
               onClick={() => handleSwatchClick(role)}
             />
           ))}
         </div>

         {/* Color picker (shown when swatch selected) */}
         {selectedRole && (
           <div className="absolute top-full left-0 mt-2 z-50">
             <ColorPicker
               colorRole={selectedRole}
               onClose={handleClosePickler}
               onRoleChange={handleRoleChange}
             />
           </div>
         )}

         {/* Palette presets */}
         <div className="mt-4 pt-4 border-t border-gray-100">
           <span className="text-xs text-gray-400 mb-2 block">Presets</span>
           <PalettePresets baseColors={colors} />
         </div>
       </div>
     );
   }
   ```
  </action>
  <verify>
    `npx tsc --noEmit` passes
    ColorTile renders with 4 swatches, contrast badge, and presets
    Hovering preset shows preview, clicking commits
    Low contrast shows warning badge (non-blocking per COLR-10)
  </verify>
  <done>
    ColorTile complete with swatches, picker, contrast badge, presets with hover preview, and role reassignment.
  </done>
</task>

</tasks>

<verification>
1. Types compile: `npx tsc --noEmit` passes
2. ColorTile renders: Shows 4 swatches stacked by role (primary, accent, background, text)
3. Contrast visible: Badge shows AA/AAA status at top of tile
4. Picker works: Click swatch -> HSL picker opens with hue ring + saturation/lightness
5. HEX input: Can type hex value directly, picker updates
6. Continuous updates: Drag picker, store updates at 60fps (check Performance tab)
7. Presets work: Hover -> preview across canvas, click -> commit
8. Role reassignment: Dropdown in picker allows changing which role is being edited
9. Low contrast: Shows warning badge but doesn't block changes
</verification>

<success_criteria>
- ColorTile displays 4 swatches with role labels and hex values
- ContrastBadge shows text/background ratio with AAA/AA/fail status
- ColorPicker uses HslColorPicker from react-colorful
- Dragging updates canvas under 50ms (rAF throttling)
- HexColorInput allows direct hex entry
- PalettePresets shows 5 presets with mini swatch previews
- Hovering preset temporarily applies palette (useHoverPreview)
- Clicking preset commits to store
- RoleDropdown allows reassigning color roles
- Low contrast shows non-blocking warning (per COLR-10)
</success_criteria>

<output>
After completion, create `.planning/phases/04-color-imagery-tiles/04-02-SUMMARY.md`
</output>
