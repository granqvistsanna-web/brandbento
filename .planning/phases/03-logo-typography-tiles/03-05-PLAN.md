---
phase: 03-logo-typography-tiles
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - src/components/panels/FontEditPanel.tsx
  - src/components/panels/index.ts
autonomous: true

must_haves:
  truths:
    - "Clicking font tile opens edit panel with font picker"
    - "User can search and select fonts"
    - "Hovering font in picker previews it across canvas"
    - "Clicking font commits the change"
    - "User can adjust weight, size, line height via sliders"
    - "Slider drag creates single undo step on release"
  artifacts:
    - path: "src/components/panels/FontEditPanel.tsx"
      provides: "Typography editing controls with font picker and sliders"
      min_lines: 120
  key_links:
    - from: "src/components/panels/FontEditPanel.tsx"
      to: "src/components/pickers/FontPicker.tsx"
      via: "FontPicker import and render"
      pattern: "FontPicker"
    - from: "src/components/panels/FontEditPanel.tsx"
      to: "src/state/canvasState.ts"
      via: "setAssets, setFontSettings, addRecentFont"
      pattern: "useCanvasStore"
---

<objective>
Create the FontEditPanel with integrated font picker and typography control sliders (weight, size, line height).

Purpose: Enable full typography customization with font selection and fine-tuning controls.
Output: FontEditPanel component with font picker, weight/size/lineHeight sliders, preview support.
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-logo-typography-tiles/03-RESEARCH.md

# Prior plans
@.planning/phases/03-logo-typography-tiles/03-02-PLAN.md
@.planning/phases/03-logo-typography-tiles/03-03-PLAN.md

@src/components/pickers/FontPicker.tsx
@src/components/controls/Slider.tsx
@src/components/panels/LogoEditPanel.tsx
@src/state/canvasState.ts
@src/data/googleFontsMetadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FontEditPanel with font picker integration</name>
  <files>
    src/components/panels/FontEditPanel.tsx
  </files>
  <action>
1. Create `src/components/panels/FontEditPanel.tsx`:
   ```typescript
   import { useCallback, useMemo } from 'react';
   import { useCanvasStore } from '@/state/canvasState';
   import { FontPicker } from '@/components/pickers';
   import { Slider } from '@/components/controls';
   import { GOOGLE_FONTS } from '@/data/googleFontsMetadata';

   interface FontEditPanelProps {
     role: 'primary' | 'secondary';
     onClose: () => void;
     onPreviewChange?: (font: string | null) => void;
   }

   export function FontEditPanel({
     role,
     onClose,
     onPreviewChange
   }: FontEditPanelProps) {
     // Get state
     const assets = useCanvasStore(state => state.assets);
     const tileSettings = useCanvasStore(state => state.tileSettings);
     const recentFonts = useCanvasStore(state => state.tileSettings.recentFonts);

     // Get actions
     const setAssets = useCanvasStore(state => state.setAssets);
     const setFontSettings = useCanvasStore(state => state.setFontSettings);
     const addRecentFont = useCanvasStore(state => state.addRecentFont);

     // Current font for this role
     const currentFont = role === 'primary' ? assets.primaryFont : assets.secondaryFont;
     const fontSettings = role === 'primary' ? tileSettings.primaryFont : tileSettings.secondaryFont;
     const settingsKey = role === 'primary' ? 'primaryFont' : 'secondaryFont';
     const assetKey = role === 'primary' ? 'primaryFont' : 'secondaryFont';

     // Get available weights for current font
     const fontMeta = useMemo(() =>
       GOOGLE_FONTS.find(f => f.family === currentFont),
       [currentFont]
     );

     const availableWeights = useMemo(() => {
       if (!fontMeta) return ['400'];
       return fontMeta.variants
         .filter(v => !v.includes('italic'))
         .map(v => v === 'regular' ? '400' : v)
         .sort((a, b) => parseInt(a) - parseInt(b));
     }, [fontMeta]);

     // Handle font selection
     const handleFontSelect = useCallback((family: string) => {
       setAssets({ [assetKey]: family });
       addRecentFont(family);

       // Reset weight if new font doesn't have current weight
       const newFontMeta = GOOGLE_FONTS.find(f => f.family === family);
       const newWeights = newFontMeta?.variants
         .filter(v => !v.includes('italic'))
         .map(v => v === 'regular' ? '400' : v) || ['400'];

       if (!newWeights.includes(fontSettings.weight === 'regular' ? '400' : fontSettings.weight)) {
         setFontSettings(settingsKey, { weight: '400' });
       }
     }, [assetKey, setAssets, addRecentFont, fontSettings.weight, settingsKey, setFontSettings]);

     // Handle weight change
     const handleWeightChange = useCallback((value: number) => {
       // Map slider value to closest available weight
       const targetWeight = value.toString();
       const closest = availableWeights.reduce((prev, curr) => {
         return Math.abs(parseInt(curr) - value) < Math.abs(parseInt(prev) - value)
           ? curr
           : prev;
       }, availableWeights[0]);

       setFontSettings(settingsKey, { weight: closest });
     }, [availableWeights, settingsKey, setFontSettings]);

     // Handle size scale change
     const handleSizeChange = useCallback((value: number) => {
       setFontSettings(settingsKey, { sizeScale: value });
     }, [settingsKey, setFontSettings]);

     // Handle line height change
     const handleLineHeightChange = useCallback((value: number) => {
       setFontSettings(settingsKey, { lineHeight: value });
     }, [settingsKey, setFontSettings]);

     // Current weight as number for slider
     const currentWeightNum = parseInt(fontSettings.weight === 'regular' ? '400' : fontSettings.weight) || 400;

     // Weight slider min/max based on available weights
     const minWeight = Math.min(...availableWeights.map(w => parseInt(w)));
     const maxWeight = Math.max(...availableWeights.map(w => parseInt(w)));

     return (
       <div className="edit-panel font-edit-panel">
         <div className="edit-panel-header">
           <h3>{role === 'primary' ? 'Primary' : 'Secondary'} Typography</h3>
           <button
             type="button"
             className="edit-panel-close"
             onClick={onClose}
             aria-label="Close panel"
           >
             Ã—
           </button>
         </div>

         <div className="edit-panel-content">
           {/* Font picker section */}
           <div className="font-picker-section">
             <label className="section-label">Font Family</label>
             <FontPicker
               currentFont={currentFont}
               recentFonts={recentFonts}
               onSelect={handleFontSelect}
               onPreviewChange={onPreviewChange}
               height={200}
             />
           </div>

           {/* Weight slider */}
           <div className="slider-section">
             <Slider
               value={currentWeightNum}
               min={minWeight}
               max={maxWeight}
               step={100}
               label="Weight"
               onChange={handleWeightChange}
               formatValue={(v) => {
                 const weightNames: Record<number, string> = {
                   100: 'Thin',
                   200: 'Extra Light',
                   300: 'Light',
                   400: 'Regular',
                   500: 'Medium',
                   600: 'Semi Bold',
                   700: 'Bold',
                   800: 'Extra Bold',
                   900: 'Black',
                 };
                 return weightNames[v] || v.toString();
               }}
             />
             {/* Weight availability indicator */}
             <div className="weight-dots">
               {[100, 200, 300, 400, 500, 600, 700, 800, 900].map(w => (
                 <div
                   key={w}
                   className={`weight-dot ${availableWeights.includes(w.toString()) ? 'available' : ''} ${currentWeightNum === w ? 'active' : ''}`}
                   title={`${w}${availableWeights.includes(w.toString()) ? '' : ' (unavailable)'}`}
                 />
               ))}
             </div>
           </div>

           {/* Size scale slider */}
           <Slider
             value={fontSettings.sizeScale}
             min={0.7}
             max={1.4}
             step={0.05}
             label="Size Scale"
             onChange={handleSizeChange}
             formatValue={(v) => `${Math.round(v * 100)}%`}
           />

           {/* Line height slider */}
           <Slider
             value={fontSettings.lineHeight}
             min={1.0}
             max={2.0}
             step={0.1}
             label="Line Height"
             onChange={handleLineHeightChange}
             formatValue={(v) => v.toFixed(1)}
           />
         </div>
       </div>
     );
   }
   ```

2. Add CSS:
   ```css
   .font-edit-panel {
     min-width: 320px;
   }

   .font-picker-section {
     display: flex;
     flex-direction: column;
     gap: 8px;
   }

   .section-label {
     font-size: 14px;
     color: #555;
     font-weight: 500;
   }

   .slider-section {
     display: flex;
     flex-direction: column;
     gap: 8px;
   }

   .weight-dots {
     display: flex;
     justify-content: space-between;
     padding: 0 4px;
   }

   .weight-dot {
     width: 8px;
     height: 8px;
     border-radius: 50%;
     background: #e0e0e0;
     transition: background 150ms ease;
   }

   .weight-dot.available {
     background: #ccc;
   }

   .weight-dot.active {
     background: #111;
   }
   ```
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Render FontEditPanel with role="primary", verify font picker displays
    Select a font, verify it updates in state
    Adjust weight slider, verify weight changes
    Verify slider creates single undo step
  </verify>
  <done>
    FontEditPanel with font picker (TYPE-09), weight slider with availability dots (TYPE-10), size slider (TYPE-11), line height slider (TYPE-12)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update panels index and verify undo batching</name>
  <files>
    src/components/panels/index.ts
  </files>
  <action>
1. Update `src/components/panels/index.ts`:
   ```typescript
   export { LogoEditPanel } from './LogoEditPanel';
   export { FontEditPanel } from './FontEditPanel';
   ```

2. Create test in App.tsx to verify slider undo batching:
   ```typescript
   // Test: Slider creates single undo step
   import { FontEditPanel } from '@/components/panels';
   import { useCanvasStore, useTemporalStore } from '@/state/canvasState';

   function SliderUndoTest() {
     const temporal = useTemporalStore();

     // Before drag: pastStates.length = N
     // After drag: pastStates.length = N+1 (single step)

     return (
       <div>
         <p>Undo stack: {temporal.pastStates.length}</p>
         <FontEditPanel role="primary" onClose={() => {}} />
         <button onClick={() => temporal.undo()}>Undo</button>
       </div>
     );
   }
   ```

3. Verification steps:
   a. Note undo stack length before slider drag
   b. Drag size slider from 1.0 to 1.4 (passes through 1.1, 1.2, 1.3)
   c. Release slider
   d. Check undo stack length - should be +1 (not +4)
   e. Click Undo - should revert to 1.0 (not 1.3)

4. Clean up test code after verification.
  </action>
  <verify>
    `npx tsc --noEmit` passes
    Slider drag creates exactly one undo entry (TYPE-13)
    Undo reverts to pre-drag value, not intermediate
  </verify>
  <done>
    FontEditPanel exported, slider undo batching verified (TYPE-13 complete)
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire preview to typography tiles</name>
  <files>
    src/components/tiles/PrimaryFontTile.tsx
    src/components/tiles/SecondaryFontTile.tsx
  </files>
  <action>
1. The tiles already accept `previewFont` prop. This task wires the preview flow.

2. Create a container component that manages preview state:
   ```typescript
   // src/components/TypographyTileWithPanel.tsx
   import { useState, useCallback } from 'react';
   import { PrimaryFontTile, SecondaryFontTile } from '@/components/tiles';
   import { FontEditPanel } from '@/components/panels';

   interface TypographyTileWithPanelProps {
     role: 'primary' | 'secondary';
     isEditing: boolean;
     onEdit: () => void;
     onClose: () => void;
   }

   export function TypographyTileWithPanel({
     role,
     isEditing,
     onEdit,
     onClose
   }: TypographyTileWithPanelProps) {
     const [previewFont, setPreviewFont] = useState<string | null>(null);

     const handlePreviewChange = useCallback((font: string | null) => {
       setPreviewFont(font);
     }, []);

     const TileComponent = role === 'primary' ? PrimaryFontTile : SecondaryFontTile;

     return (
       <div className="tile-with-panel">
         <TileComponent
           onClick={onEdit}
           isEditing={isEditing}
           previewFont={previewFont}
         />

         {isEditing && (
           <FontEditPanel
             role={role}
             onClose={onClose}
             onPreviewChange={handlePreviewChange}
           />
         )}
       </div>
     );
   }
   ```

3. This component pattern:
   - Tile receives previewFont from local state
   - FontEditPanel calls onPreviewChange when hovering fonts
   - Tile updates display immediately (TYPE-08)
   - On font select, state commits and preview clears

4. Export from components:
   ```typescript
   // src/components/index.ts (add)
   export { TypographyTileWithPanel } from './TypographyTileWithPanel';
   ```

5. Integration with canvas (Phase 2) will use this pattern to:
   - Show tile normally
   - On click: set editingTileId in state
   - Render edit panel inline
   - Preview font on hover
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Render TypographyTileWithPanel, hover fonts in picker
    Verify tile font changes during hover (preview)
    Click font, verify tile commits change
    Hover again, verify preview works after commit
  </verify>
  <done>
    Typography tiles wire to FontEditPanel with hover preview (TYPE-08), click commits (TYPE-09)
  </done>
</task>

</tasks>

<verification>
1. TYPE-08: Hovering font in picker temporarily previews across canvas (via previewFont prop)
2. TYPE-09: Clicking font commits and updates state
3. TYPE-10: Weight slider snaps to available weights
4. TYPE-11: Size scale slider updates with live preview
5. TYPE-12: Line height slider updates with live preview
6. TYPE-13: Slider drag creates single undo step on release
</verification>

<success_criteria>
- FontEditPanel renders with font picker and three sliders
- Font selection updates state and adds to recent fonts
- Weight slider shows available weights with dots
- All sliders use pause/resume for single undo step
- Hover preview works via onPreviewChange callback
- TypographyTileWithPanel wires preview flow correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-logo-typography-tiles/03-05-SUMMARY.md`
</output>
