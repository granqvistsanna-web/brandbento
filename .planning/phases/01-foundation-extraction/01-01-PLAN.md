---
phase: 01-foundation-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cors-proxy/src/index.js
  - cors-proxy/wrangler.toml
  - cors-proxy/package.json
autonomous: true

must_haves:
  truths:
    - "CORS proxy responds to GET requests with target URL content and CORS headers"
    - "CORS proxy responds to OPTIONS preflight with appropriate CORS headers"
    - "Rate limiting returns 429 after 10 requests per minute from same IP"
    - "Proxy is deployed and accessible via public URL"
  artifacts:
    - path: "cors-proxy/src/index.js"
      provides: "Cloudflare Worker CORS proxy with rate limiting"
      min_lines: 50
    - path: "cors-proxy/wrangler.toml"
      provides: "Worker configuration with rate limit binding"
      contains: "rate_limit"
  key_links:
    - from: "cors-proxy/src/index.js"
      to: "env.RATE_LIMITER"
      via: "rate limit binding"
      pattern: "env\\.RATE_LIMITER\\.limit"
---

<objective>
Deploy a Cloudflare Worker CORS proxy with rate limiting to enable browser-based fetching of external URLs.

Purpose: Brand extraction requires fetching HTML/CSS from external sites. Browsers block cross-origin requests without CORS headers. A self-hosted proxy avoids reliance on unreliable third-party services.

Output: Production-deployed Cloudflare Worker at a public URL that adds CORS headers and enforces 10 req/min rate limit per IP.
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-extraction/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare Worker CORS proxy with rate limiting</name>
  <files>cors-proxy/src/index.js, cors-proxy/wrangler.toml, cors-proxy/package.json</files>
  <action>
Create a new directory `cors-proxy/` at the project root.

Create `cors-proxy/package.json`:
```json
{
  "name": "brand-bento-cors-proxy",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "wrangler dev",
    "deploy": "wrangler deploy"
  },
  "devDependencies": {
    "wrangler": "^3.0.0"
  }
}
```

Create `cors-proxy/wrangler.toml`:
```toml
name = "brand-bento-cors-proxy"
main = "src/index.js"
compatibility_date = "2024-01-01"

[[rate_limit]]
binding = "RATE_LIMITER"
namespace_id = "1"
limit = 10
period = 60
```

Create `cors-proxy/src/index.js` implementing:
1. OPTIONS handler returning CORS preflight headers (Access-Control-Allow-Origin: *, Allow-Methods: GET, HEAD, OPTIONS, Allow-Headers: Content-Type, Max-Age: 86400)
2. GET handler that:
   - Reads `url` query parameter (return 400 if missing)
   - Calls `env.RATE_LIMITER.limit({ key: clientIP })` using CF-Connecting-IP header
   - Returns 429 with CORS headers if rate limited
   - Fetches target URL with 5-second timeout
   - Validates content-type is text/html or text/css (return 400 otherwise)
   - Returns response body with CORS headers added
3. Error handling returning 502 for fetch failures

Reference the RESEARCH.md pattern "Complete CORS Proxy with Rate Limiting (Production-Ready)" for the exact implementation.
  </action>
  <verify>
Run `cd cors-proxy && npm install` completes without errors.
File `cors-proxy/src/index.js` exists and contains rate limiting logic.
  </verify>
  <done>
CORS proxy source files exist with rate limiting, OPTIONS handling, and GET handler implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy CORS proxy to Cloudflare Workers</name>
  <files>cors-proxy/wrangler.toml</files>
  <action>
Deploy the worker to Cloudflare:

```bash
cd cors-proxy
npx wrangler deploy
```

This requires Cloudflare authentication. If not already logged in, run `npx wrangler login` first.

After deployment, note the worker URL (format: https://brand-bento-cors-proxy.{subdomain}.workers.dev).

Create a `.env.example` file at project root documenting the proxy URL:
```
# Brand Bento Environment Variables
VITE_CORS_PROXY_URL=https://brand-bento-cors-proxy.your-subdomain.workers.dev
```

Test the deployed proxy by making a curl request:
```bash
curl "https://{worker-url}?url=https://example.com" -I
```

Verify response includes `Access-Control-Allow-Origin: *` header.
  </action>
  <verify>
`npx wrangler deploy` succeeds and outputs a workers.dev URL.
`curl "{worker-url}?url=https://example.com"` returns HTML content with CORS headers.
  </verify>
  <done>
CORS proxy is deployed to Cloudflare Workers and responds to requests with proper CORS headers.
  </done>
</task>

</tasks>

<verification>
1. `cors-proxy/` directory exists with src/index.js, wrangler.toml, package.json
2. Worker is deployed (check with `cd cors-proxy && npx wrangler whoami`)
3. GET request to `{proxy-url}?url=https://example.com` returns HTML with CORS headers
4. OPTIONS request returns preflight response with CORS headers
5. Rate limiting returns 429 after burst of requests (optional manual test)
</verification>

<success_criteria>
- CORS proxy deployed to Cloudflare Workers
- Proxy URL documented in .env.example
- GET requests return target content with CORS headers
- OPTIONS preflight handled correctly
- Rate limiting configured at 10 req/min per IP
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-extraction/01-01-SUMMARY.md`
</output>
