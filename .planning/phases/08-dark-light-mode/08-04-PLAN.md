---
phase: 08-dark-light-mode
plan: 04
type: execute
wave: 3
depends_on: [08-02, 08-03]
files_modified:
  - src/App.tsx
  - src/components/ThemeToggle.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between dark and light mode via a visible control"
    - "Toggle shows current theme state (sun for light, moon for dark)"
    - "System option is available as a third choice"
  artifacts:
    - path: "src/components/ThemeToggle.tsx"
      provides: "ThemeToggle component with dropdown for light/dark/system"
      exports: ["ThemeToggle"]
    - path: "src/App.tsx"
      provides: "ThemeToggle in toolbar replacing simple icon button"
      contains: "ThemeToggle"
  key_links:
    - from: "src/components/ThemeToggle.tsx"
      to: "src/hooks/useTheme.ts"
      via: "reads theme and calls setTheme"
      pattern: "useTheme\\(\\)"
    - from: "src/App.tsx"
      to: "src/components/ThemeToggle.tsx"
      via: "renders ThemeToggle in toolbar"
      pattern: "<ThemeToggle"
---

<objective>
Create a theme toggle component and integrate it into the toolbar.

Purpose: Give users a visible, accessible way to switch between light mode, dark mode, and system preference. The toggle should replace the existing preview toggle button in the toolbar.

Output: ThemeToggle component, integrated into App.tsx toolbar
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-dark-light-mode/08-RESEARCH.md
@.planning/phases/08-dark-light-mode/08-02-SUMMARY.md
@src/App.tsx
@src/hooks/useTheme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeToggle component</name>
  <files>src/components/ThemeToggle.tsx</files>
  <action>
Create a new component that provides theme switching with a dropdown menu.

The component should:
1. Show current theme icon (Sun for light, Moon for dark, Monitor for system)
2. Open dropdown with three options on click
3. Call setTheme when option is selected
4. Match the existing Figma-style design patterns

```tsx
import { useState, useRef, useEffect } from 'react';
import { Sun, Moon, Monitor, Check } from 'lucide-react';
import { motion, AnimatePresence } from 'motion/react';
import { useTheme } from '../hooks/useTheme';

const themeOptions = [
  { value: 'light', label: 'Light', icon: Sun },
  { value: 'dark', label: 'Dark', icon: Moon },
  { value: 'system', label: 'System', icon: Monitor },
] as const;

export function ThemeToggle() {
  const { theme, setTheme, resolvedTheme } = useTheme();
  const [isOpen, setIsOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  // Get the icon for the current resolved theme
  const CurrentIcon = resolvedTheme === 'dark' ? Moon : Sun;

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <div className="relative" ref={menuRef}>
      <motion.button
        onClick={() => setIsOpen(!isOpen)}
        className="icon-btn"
        style={{
          background: isOpen ? 'var(--accent-muted)' : 'transparent',
          color: isOpen ? 'var(--accent)' : 'var(--sidebar-text-secondary)',
        }}
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        aria-label="Toggle theme"
        aria-expanded={isOpen}
      >
        <CurrentIcon size={16} />
      </motion.button>

      <AnimatePresence>
        {isOpen && (
          <motion.div
            initial={{ opacity: 0, y: -4 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -4 }}
            className="absolute top-full right-0 mt-1 py-1 rounded-lg z-50 min-w-[120px]"
            style={{
              background: 'var(--sidebar-bg-elevated)',
              border: '1px solid var(--sidebar-border)',
              boxShadow: 'var(--shadow-xl)',
            }}
          >
            {themeOptions.map((option) => {
              const Icon = option.icon;
              const isSelected = theme === option.value;

              return (
                <button
                  key={option.value}
                  onClick={() => {
                    setTheme(option.value);
                    setIsOpen(false);
                  }}
                  className="w-full px-3 py-1.5 flex items-center gap-2 text-left transition-fast"
                  style={{
                    background: isSelected ? 'var(--accent-muted)' : 'transparent',
                    color: isSelected ? 'var(--accent)' : 'var(--sidebar-text)',
                  }}
                  onMouseEnter={(e) => {
                    if (!isSelected) {
                      e.currentTarget.style.background = 'var(--sidebar-bg-hover)';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = isSelected
                      ? 'var(--accent-muted)'
                      : 'transparent';
                  }}
                >
                  <Icon size={14} />
                  <span className="text-11 flex-1">{option.label}</span>
                  {isSelected && <Check size={12} />}
                </button>
              );
            })}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
```

Key behaviors:
- Button shows Sun or Moon based on resolved theme (not selected theme)
- Dropdown shows all three options with current selection checked
- Selecting an option immediately applies the theme
- Matches existing Figma-style dropdown patterns (see FileMenu in App.tsx)
  </action>
  <verify>
File exists at src/components/ThemeToggle.tsx.
Exports ThemeToggle component.
Uses useTheme hook.
  </verify>
  <done>
ThemeToggle component renders theme switching dropdown.
Shows correct icon based on resolved theme.
Provides light/dark/system options with check mark on current.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace darkModePreview toggle with ThemeToggle in toolbar</name>
  <files>src/App.tsx</files>
  <action>
Update App.tsx to use the new ThemeToggle component instead of the existing dark mode preview button.

1. Add import at the top:
```tsx
import { ThemeToggle } from './components/ThemeToggle';
```

2. Find this existing code in the toolbar (around line 303-308):
```tsx
<ToolbarButton
  icon={darkModePreview ? Sun : Moon}
  label={darkModePreview ? "Light Mode" : "Dark Mode"}
  onClick={toggleDarkMode}
  active={darkModePreview}
/>
```

3. Replace it with:
```tsx
<ThemeToggle />
```

4. Remove `darkModePreview` and `toggleDarkMode` from the destructuring at the top of the App component (around line 245-246) since they are no longer used here.

Note: Keep the `darkModePreview` in the store if it's used elsewhere (like BentoCanvas for brand preview). The app theme and brand preview are separate concerns.

5. Also remove the imports for Moon and Sun from lucide-react if they're no longer used anywhere in App.tsx (check if other components still need them).
  </action>
  <verify>
`grep -n "ThemeToggle" src/App.tsx` shows import and usage.
`grep -n "darkModePreview.*Sun.*Moon" src/App.tsx` should NOT match (old code removed).
App runs without errors: `npm run dev`
ThemeToggle appears in toolbar and works.
  </verify>
  <done>
App.tsx imports and renders ThemeToggle in toolbar.
Old darkModePreview toggle button is removed from toolbar.
Theme switching works via the new dropdown.
  </done>
</task>

</tasks>

<verification>
1. Component exists: `ls src/components/ThemeToggle.tsx`
2. Used in App: `grep "ThemeToggle" src/App.tsx`
3. Uses hook: `grep "useTheme" src/components/ThemeToggle.tsx`
4. Build succeeds: `npm run build`
5. Manual test:
   - Open app
   - Click theme toggle button in toolbar
   - Verify dropdown appears with Light/Dark/System options
   - Select each option, verify theme changes
   - Verify selection persists after page refresh
</verification>

<success_criteria>
- ThemeToggle component exists and is rendered in toolbar
- Clicking toggle opens dropdown with three options
- Selecting an option changes the theme immediately
- Icon reflects current resolved theme (Sun/Moon)
- Old toggle button is removed
- Theme preference persists across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/08-dark-light-mode/08-04-SUMMARY.md`
</output>
