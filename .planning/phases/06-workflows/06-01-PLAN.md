---
phase: 06-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/hooks/useKeyboardShortcuts.ts
  - src/components/Toolbar.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Cmd+Z undoes the last action"
    - "Cmd+Shift+Z redoes the last undone action"
    - "Browser default undo/redo is prevented"
    - "Floating toolbar appears at bottom-center of canvas"
    - "Toolbar auto-hides after 3 seconds of inactivity"
    - "Toolbar reappears on mouse movement"
  artifacts:
    - path: "src/hooks/useKeyboardShortcuts.ts"
      provides: "Keyboard shortcut handler for undo/redo"
      exports: ["useKeyboardShortcuts"]
    - path: "src/components/Toolbar.tsx"
      provides: "Floating toolbar with auto-hide behavior"
      exports: ["Toolbar"]
    - path: "package.json"
      contains: "html-to-image"
    - path: "package.json"
      contains: "react-hot-toast"
  key_links:
    - from: "src/hooks/useKeyboardShortcuts.ts"
      to: "useBrandStore"
      via: "undo/redo actions"
      pattern: "undo\\(\\)|redo\\(\\)"
    - from: "src/App.tsx"
      to: "src/hooks/useKeyboardShortcuts.ts"
      via: "hook invocation"
      pattern: "useKeyboardShortcuts"
    - from: "src/App.tsx"
      to: "src/components/Toolbar.tsx"
      via: "component render"
      pattern: "<Toolbar"
---

<objective>
Install dependencies, create keyboard shortcuts hook, and build the floating Toolbar component with auto-hide.

Purpose: Foundation for all Phase 6 workflow features - installs html-to-image for export, react-hot-toast for notifications, wires Cmd+Z/Cmd+Shift+Z shortcuts, and creates the floating toolbar UI (TOOL-01, TOOL-02, TOOL-03).

Output: Working keyboard shortcuts, installed dependencies, floating toolbar with auto-hide behavior.
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-workflows/06-RESEARCH.md
@src/App.tsx

Key context from research:
- Use html-to-image@1.11.13 (locked version, newer has bugs)
- Use react-hot-toast (5KB, simple API)
- useBrandStore already has undo/redo actions that check history.past.length / history.future.length
- Must prevent default browser Cmd+Z behavior with e.preventDefault()
- TOOL-01: Floating toolbar at bottom-center
- TOOL-02: Toolbar contains Undo, Redo, Export PNG, Share Link, Reset
- TOOL-03: Auto-hide after 3 seconds of mouse inactivity
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install workflow dependencies</name>
  <files>package.json</files>
  <action>
Install html-to-image and react-hot-toast:

```bash
npm install html-to-image@1.11.13 react-hot-toast
```

IMPORTANT: Lock html-to-image to 1.11.13 - newer versions have export bugs (see 06-RESEARCH.md pitfall #1).
  </action>
  <verify>Run `npm list html-to-image react-hot-toast` - should show 1.11.13 and latest respectively</verify>
  <done>Both packages appear in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create useKeyboardShortcuts hook</name>
  <files>src/hooks/useKeyboardShortcuts.ts</files>
  <action>
Create a hook that listens for keyboard shortcuts and triggers undo/redo:

```typescript
import { useEffect } from 'react';
import { useBrandStore } from '../store/useBrandStore';

export function useKeyboardShortcuts() {
  const undo = useBrandStore((state) => state.undo);
  const redo = useBrandStore((state) => state.redo);
  const history = useBrandStore((state) => state.history);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Check for Cmd (Mac) or Ctrl (Windows/Linux)
      const isMod = e.metaKey || e.ctrlKey;

      if (isMod && e.key === 'z') {
        e.preventDefault(); // CRITICAL: Prevent browser default undo

        if (e.shiftKey) {
          // Cmd+Shift+Z = Redo
          if (history.future.length > 0) {
            redo();
          }
        } else {
          // Cmd+Z = Undo
          if (history.past.length > 0) {
            undo();
          }
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [undo, redo, history.past.length, history.future.length]);
}
```

The hook:
1. Gets undo/redo actions from useBrandStore
2. Listens for keydown events
3. Prevents default browser behavior
4. Checks canUndo/canRedo before calling actions
  </action>
  <verify>File exists and exports useKeyboardShortcuts function</verify>
  <done>Hook created with proper event handling and cleanup</done>
</task>

<task type="auto">
  <name>Task 3: Create Toolbar component with auto-hide</name>
  <files>src/components/Toolbar.tsx</files>
  <action>
Create the floating Toolbar component at bottom-center with auto-hide behavior (TOOL-01, TOOL-02, TOOL-03):

```typescript
import { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { RotateCcw, RotateCw, Download, Share2, RefreshCw } from 'lucide-react';
import { useBrandStore } from '../store/useBrandStore';

interface ToolbarButtonProps {
  icon: React.ElementType;
  label: string;
  shortcut?: string;
  onClick?: () => void;
  disabled?: boolean;
}

const ToolbarButton = ({ icon: Icon, label, shortcut, onClick, disabled }: ToolbarButtonProps) => {
  const [showTooltip, setShowTooltip] = useState(false);

  return (
    <div className="relative">
      <motion.button
        onClick={onClick}
        disabled={disabled}
        onMouseEnter={() => setShowTooltip(true)}
        onMouseLeave={() => setShowTooltip(false)}
        className="w-9 h-9 flex items-center justify-center rounded-lg transition-colors"
        style={{
          background: 'transparent',
          color: disabled ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)',
          opacity: disabled ? 0.4 : 1,
          cursor: disabled ? 'not-allowed' : 'pointer',
        }}
        whileHover={!disabled ? { background: 'var(--sidebar-bg-hover)' } : {}}
        whileTap={!disabled ? { scale: 0.95 } : {}}
      >
        <Icon size={18} />
      </motion.button>

      <AnimatePresence>
        {showTooltip && (
          <motion.div
            initial={{ opacity: 0, y: 4 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 4 }}
            className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 z-50"
          >
            <div
              className="px-2 py-1 rounded text-xs whitespace-nowrap flex items-center gap-2"
              style={{
                background: 'var(--sidebar-bg-elevated)',
                color: 'var(--sidebar-text)',
                border: '1px solid var(--sidebar-border)',
                boxShadow: 'var(--shadow-lg)',
              }}
            >
              <span>{label}</span>
              {shortcut && (
                <span
                  className="px-1 rounded text-[10px]"
                  style={{ background: 'var(--sidebar-bg)', color: 'var(--sidebar-text-muted)' }}
                >
                  {shortcut}
                </span>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

const ToolbarDivider = () => (
  <div className="w-px h-6 mx-1" style={{ background: 'var(--sidebar-border)' }} />
);

interface ToolbarProps {
  onExport?: () => void;
  onShare?: () => void;
  onReset?: () => void;
}

export function Toolbar({ onExport, onShare, onReset }: ToolbarProps) {
  const [isVisible, setIsVisible] = useState(true);
  const timeoutRef = useRef<number>();

  const { undo, redo, history } = useBrandStore();

  const canUndo = history.past.length > 0;
  const canRedo = history.future.length > 0;

  // TOOL-03: Auto-hide after 3 seconds of inactivity
  useEffect(() => {
    const handleMouseMove = () => {
      setIsVisible(true);

      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }

      timeoutRef.current = window.setTimeout(() => {
        setIsVisible(false);
      }, 3000);
    };

    // Initial visibility
    handleMouseMove();

    window.addEventListener('mousemove', handleMouseMove);
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
    };
  }, []);

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: 20 }}
          transition={{ duration: 0.2 }}
          className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50"
          data-export-exclude="true"
        >
          {/* TOOL-01: Floating toolbar container */}
          <div
            className="flex items-center gap-1 px-2 py-1.5 rounded-xl"
            style={{
              background: 'var(--sidebar-bg)',
              border: '1px solid var(--sidebar-border)',
              boxShadow: 'var(--shadow-xl)',
            }}
          >
            {/* TOOL-02: Undo, Redo, Export, Share, Reset */}
            <ToolbarButton
              icon={RotateCcw}
              label="Undo"
              shortcut="Cmd+Z"
              onClick={undo}
              disabled={!canUndo}
            />
            <ToolbarButton
              icon={RotateCw}
              label="Redo"
              shortcut="Cmd+Shift+Z"
              onClick={redo}
              disabled={!canRedo}
            />

            <ToolbarDivider />

            <ToolbarButton
              icon={Download}
              label="Export PNG"
              onClick={onExport}
            />
            <ToolbarButton
              icon={Share2}
              label="Share Link"
              onClick={onShare}
            />

            <ToolbarDivider />

            <ToolbarButton
              icon={RefreshCw}
              label="Reset"
              onClick={onReset}
            />
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

Key features:
- TOOL-01: Fixed position at bottom-center
- TOOL-02: Contains Undo, Redo, Export, Share, Reset buttons
- TOOL-03: Auto-hide after 3 seconds, reappears on mouse move
- Uses motion/react for smooth appear/disappear animation
- Passes onExport/onShare/onReset props for wiring in later plans
- data-export-exclude="true" so it won't appear in PNG exports
  </action>
  <verify>File exists with Toolbar export and ToolbarButton internal component</verify>
  <done>Toolbar component created with auto-hide behavior</done>
</task>

<task type="auto">
  <name>Task 4: Wire keyboard shortcuts and Toolbar in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Import and wire the keyboard shortcuts hook and Toolbar component:

1. Add imports at top:
```typescript
import { useKeyboardShortcuts } from './hooks/useKeyboardShortcuts';
import { Toolbar } from './components/Toolbar';
```

2. Call the keyboard shortcuts hook inside the App component (near other hooks):
```typescript
export default function App() {
  useTheme();
  useKeyboardShortcuts(); // Add this line

  const { undo, redo, history, loadRandomTemplate } = useBrandStore();
  // ... rest of component
}
```

3. Add the Toolbar component at the end of the main layout (before the closing </main> or after </footer>):
```tsx
{/* Floating Toolbar */}
<Toolbar />
```

Note: The onExport, onShare, and onReset props will be wired in Plans 06-02 and 06-03. For now, the Toolbar renders with placeholder buttons that don't do anything yet except Undo/Redo which work.

4. IMPORTANT: Keep the existing header with undo/redo buttons - they will remain as alternative controls. The floating Toolbar provides a second way to access these features.
  </action>
  <verify>Run the dev server, verify: (1) Cmd+Z/Cmd+Shift+Z work, (2) Floating toolbar appears at bottom, (3) Toolbar hides after 3s of no mouse movement</verify>
  <done>Keyboard shortcuts and Toolbar are wired in App.tsx</done>
</task>

</tasks>

<verification>
1. `npm list html-to-image` shows 1.11.13
2. `npm list react-hot-toast` shows installed version
3. Press Cmd+Z after changing a color/font - change is undone
4. Press Cmd+Shift+Z - change is redone
5. Pressing Cmd+Z in a text field doesn't conflict (browser undo prevented)
6. Floating toolbar visible at bottom-center of canvas
7. Toolbar auto-hides after 3 seconds of mouse inactivity
8. Moving mouse makes toolbar reappear
9. Toolbar has Undo, Redo, Export, Share, Reset buttons
</verification>

<success_criteria>
- [ ] html-to-image@1.11.13 installed
- [ ] react-hot-toast installed
- [ ] useKeyboardShortcuts hook exists and works
- [ ] Cmd+Z undoes last change
- [ ] Cmd+Shift+Z redoes undone change
- [ ] Browser default undo is prevented (no double-undo behavior)
- [ ] Toolbar component renders at bottom-center
- [ ] Toolbar auto-hides after 3 seconds
- [ ] Toolbar reappears on mouse movement
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflows/06-01-SUMMARY.md`
</output>
