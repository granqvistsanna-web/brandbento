---
phase: 06-workflows
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/utils/export.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Export button triggers PNG download"
    - "Exported image excludes toolbar and controls"
    - "Export handles high-DPI screens correctly"
  artifacts:
    - path: "src/utils/export.ts"
      provides: "PNG export logic with filtering and scaling"
      exports: ["exportToPng"]
  key_links:
    - from: "src/utils/export.ts"
      to: "html-to-image"
      via: "toPng import"
      pattern: "import.*toPng.*from.*html-to-image"
    - from: "src/App.tsx"
      to: "src/utils/export.ts"
      via: "export button onClick"
      pattern: "exportToPng"
---

<objective>
Implement PNG export functionality that captures the bento canvas cleanly.

Purpose: Allow users to download their brand moodboard as a high-quality PNG image for sharing or presentations.

Output: Working Export button that downloads a clean PNG of the bento grid.
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflows/06-RESEARCH.md
@src/components/BentoCanvas.jsx

Key requirements:
- EXPRT-01: Export PNG captures bento grid as clean image
- EXPRT-02: Exclude toolbar, background, open edit panels
- EXPRT-03: Use html-to-image (not html2canvas)
- EXPRT-04: Handle high-DPI with devicePixelRatio scaling

The BentoCanvas component is the export target. The header/footer/toolbar should be excluded.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export utility function</name>
  <files>src/utils/export.ts</files>
  <action>
Create the PNG export utility using html-to-image:

```typescript
import { toPng } from 'html-to-image';

export async function exportToPng(
  canvasElement: HTMLElement,
  filename: string = 'brandbento'
): Promise<void> {
  // Filter function to exclude UI elements from export
  const filter = (node: HTMLElement): boolean => {
    // Skip non-element nodes
    if (!(node instanceof HTMLElement)) return true;

    // List of class names to exclude from export
    const excludeClasses = [
      'toolbar',
      'edit-panel',
      'control-panel',
      'controls',
      'tooltip',
      'overlay',
      'modal',
    ];

    // Check if node has any excluded class
    if (node.classList) {
      for (const cls of excludeClasses) {
        if (node.classList.contains(cls)) {
          return false;
        }
      }
    }

    // Also check data attributes for export exclusion
    if (node.dataset?.exportExclude === 'true') {
      return false;
    }

    return true;
  };

  try {
    const dataUrl = await toPng(canvasElement, {
      cacheBust: true,
      // EXPRT-04: Scale for high-DPI screens
      pixelRatio: window.devicePixelRatio,
      filter,
      // Improve quality
      quality: 1.0,
      // Handle background
      backgroundColor: undefined, // Use transparent or element's bg
    });

    // Trigger download
    const link = document.createElement('a');
    link.download = `${filename}-${Date.now()}.png`;
    link.href = dataUrl;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (error) {
    console.error('Export failed:', error);
    throw new Error('Failed to export PNG. Please try again.');
  }
}
```

Key points:
- Uses toPng from html-to-image (v1.11.13)
- Filters out toolbar, edit panels, controls, tooltips
- Respects devicePixelRatio for high-DPI screens
- Returns a promise so caller can handle errors
  </action>
  <verify>File exists with exportToPng function</verify>
  <done>Export utility created with proper filtering and DPI handling</done>
</task>

<task type="auto">
  <name>Task 2: Wire export button in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Wire the Export button to trigger the export function:

1. Add import:
```typescript
import { exportToPng } from './utils/export';
```

2. Add ref to target the main canvas area. Find the BentoCanvas section and wrap it in a div with a ref:
```typescript
const canvasRef = useRef<HTMLDivElement>(null);
```

3. Create export handler:
```typescript
const handleExport = async () => {
  if (!canvasRef.current) return;

  try {
    await exportToPng(canvasRef.current, 'brandbento');
  } catch (error) {
    console.error('Export error:', error);
    // Toast will be added in Plan 03
  }
};
```

4. Update the Export button to call handleExport:
```tsx
<motion.button
  className="btn-figma btn-figma-primary"
  whileHover={{ scale: 1.02 }}
  whileTap={{ scale: 0.98 }}
  onClick={handleExport}
>
  <Download size={14} />
  <span>Export</span>
</motion.button>
```

5. Wrap the BentoCanvas in a ref div:
```tsx
{/* Center: Canvas */}
<div ref={canvasRef} className="flex-1 overflow-auto">
  <BentoCanvas />
</div>
```

Also add useRef to the imports from React.
  </action>
  <verify>Click Export button - should trigger PNG download</verify>
  <done>Export button is wired and triggers download</done>
</task>

<task type="auto">
  <name>Task 3: Add export-exclude markers to UI elements</name>
  <files>src/App.tsx</files>
  <action>
Add data-export-exclude="true" attribute to elements that should be hidden in export:

1. Add to the header toolbar:
```tsx
<header
  data-export-exclude="true"
  className="h-12 flex items-center justify-between px-2 z-20 flex-shrink-0"
  ...
>
```

2. Add to the footer status bar:
```tsx
<footer
  data-export-exclude="true"
  className="h-6 flex items-center justify-between px-3 flex-shrink-0"
  ...
>
```

3. Add to the ControlPanel wrapper if visible during export:
```tsx
{/* Left: Control Panel */}
<div data-export-exclude="true">
  <ControlPanel />
</div>
```

The export filter function already checks for data-export-exclude="true", so these elements will be excluded.
  </action>
  <verify>Export PNG and verify it only contains the bento canvas, no toolbars</verify>
  <done>UI elements are properly excluded from export</done>
</task>

</tasks>

<verification>
1. Click Export button - downloads a PNG file
2. Open the PNG - shows only the bento grid, no toolbar/footer
3. On Retina/high-DPI screen, image is appropriately scaled
4. Export works in both light and dark mode
5. Large images (with hero photos) export correctly
</verification>

<success_criteria>
- [ ] Export button triggers PNG download
- [ ] Exported image contains only the bento canvas
- [ ] Toolbar, footer, control panel are excluded
- [ ] Image quality is high on Retina displays
- [ ] Export handles images embedded in tiles
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflows/06-02-SUMMARY.md`
</output>
