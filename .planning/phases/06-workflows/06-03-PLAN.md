---
phase: 06-workflows
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/utils/sharing.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Share button copies URL to clipboard"
    - "Toast notification shows 'Copied!' on success"
    - "Reset returns tiles to default state"
    - "Reset shows confirmation dialog first"
  artifacts:
    - path: "src/utils/sharing.ts"
      provides: "URL generation and clipboard copy"
      exports: ["generateShareUrl", "copyToClipboard"]
  key_links:
    - from: "src/utils/sharing.ts"
      to: "lz-string compression"
      via: "LZString import"
      pattern: "LZString\\.compressToEncodedURIComponent"
    - from: "src/App.tsx"
      to: "react-hot-toast"
      via: "Toaster and toast imports"
      pattern: "import.*toast.*from.*react-hot-toast"
---

<objective>
Implement Share Link functionality with clipboard copy and toast feedback, plus Reset with confirmation.

Purpose: Allow users to share their brand moodboard via URL and reset to defaults when needed.

Output: Working Share button with toast notification, Reset button with confirmation dialog.
</objective>

<execution_context>
@/Users/sannagranqvist/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sannagranqvist/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflows/06-RESEARCH.md
@src/utils/compression.ts
@src/store/useBrandStore.js

Key requirements:
- SHAR-01: Generate URL with compressed canvas state
- SHAR-02: Copy to clipboard with "Copied!" toast
- TOOL-07: Reset returns all tiles to extracted state with confirmation
- TOOL-08: Reset is undoable

The compression utility already exists - reuse it for share URL generation.
useBrandStore has a history system that makes reset undoable automatically.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sharing utility</name>
  <files>src/utils/sharing.ts</files>
  <action>
Create the sharing utility that generates a shareable URL:

```typescript
import LZString from 'lz-string';

interface ShareableState {
  brand: any;
  tiles: any[];
}

/**
 * Generate a shareable URL with compressed state
 */
export function generateShareUrl(state: ShareableState): string {
  // Create a minimal shareable state (exclude UI-only fields)
  const shareableState = {
    brand: state.brand,
    tiles: state.tiles,
    // Mark as read-only view
    v: 1, // version for future compatibility
  };

  const json = JSON.stringify(shareableState);
  const compressed = LZString.compressToEncodedURIComponent(json);

  // Build URL with hash for state and query param for read-only
  const url = new URL(window.location.href);
  url.hash = compressed;
  url.searchParams.set('view', 'readonly');

  return url.toString();
}

/**
 * Copy text to clipboard with fallback
 */
export async function copyToClipboard(text: string): Promise<boolean> {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (error) {
    console.error('Clipboard write failed:', error);

    // Fallback for older browsers or non-HTTPS
    try {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textarea);
      return success;
    } catch (fallbackError) {
      console.error('Fallback copy failed:', fallbackError);
      return false;
    }
  }
}
```

Key points:
- Uses LZString for compression (same as existing compression.ts)
- Adds ?view=readonly query param for read-only detection
- Includes fallback for non-HTTPS environments
  </action>
  <verify>File exists with generateShareUrl and copyToClipboard exports</verify>
  <done>Sharing utility created with URL generation and clipboard copy</done>
</task>

<task type="auto">
  <name>Task 2: Add toast provider to App</name>
  <files>src/App.tsx</files>
  <action>
Add react-hot-toast Toaster component to App:

1. Add imports at top:
```typescript
import toast, { Toaster } from 'react-hot-toast';
```

2. Add the Toaster component at the end of the root div (before closing </div>):
```tsx
{/* Toast notifications */}
<Toaster
  position="bottom-center"
  toastOptions={{
    duration: 2000,
    style: {
      background: 'var(--sidebar-bg)',
      color: 'var(--sidebar-text)',
      border: '1px solid var(--sidebar-border)',
      fontSize: '13px',
    },
    success: {
      iconTheme: {
        primary: 'var(--success)',
        secondary: 'var(--sidebar-bg)',
      },
    },
    error: {
      iconTheme: {
        primary: 'var(--error)',
        secondary: 'var(--sidebar-bg)',
      },
    },
  }}
/>
```

Position at bottom-center matches design (toolbar also at bottom).
  </action>
  <verify>Toast should appear on screen when triggered</verify>
  <done>Toaster provider added with themed styling</done>
</task>

<task type="auto">
  <name>Task 3: Wire Share and Reset buttons</name>
  <files>src/App.tsx</files>
  <action>
Wire the Share and Reset functionality:

1. Add imports:
```typescript
import { generateShareUrl, copyToClipboard } from './utils/sharing';
```

2. Get reset action from store and add handler:
```typescript
const { undo, redo, history, loadRandomTemplate, brand, tiles } = useBrandStore();

// Reset to defaults (loads a random template as "reset")
const handleReset = () => {
  const confirmed = window.confirm(
    'Reset moodboard to a new template? This can be undone with Cmd+Z.'
  );
  if (confirmed) {
    loadRandomTemplate();
    toast.success('Moodboard reset!');
  }
};
```

3. Add share handler:
```typescript
const handleShare = async () => {
  const shareUrl = generateShareUrl({ brand, tiles });

  const success = await copyToClipboard(shareUrl);
  if (success) {
    toast.success('Copied!');
  } else {
    toast.error('Failed to copy link');
  }
};
```

4. Wire the Share button (find the ghost button with Share2 icon):
```tsx
<motion.button
  className="btn-figma btn-figma-ghost"
  whileHover={{ scale: 1.02 }}
  whileTap={{ scale: 0.98 }}
  onClick={handleShare}
>
  <Share2 size={14} />
  <span>Share</span>
</motion.button>
```

5. Add a Reset button in the toolbar (after the theme toggle):
```tsx
<ToolbarButton
  icon={RotateCcw}
  label="Reset"
  onClick={handleReset}
/>
```

Note: The Undo button already uses RotateCcw. Use a different approach:
- Import RefreshCw from lucide-react for Reset
- Or reuse RotateCcw with a different label

Actually, looking at the code, RotateCcw is Undo and RotateCw is Redo. Import RefreshCw:
```typescript
import { RefreshCw } from 'lucide-react';
```

Then add:
```tsx
<ToolbarButton
  icon={RefreshCw}
  label="Reset to Template"
  onClick={handleReset}
/>
```
  </action>
  <verify>Click Share - copies URL and shows toast. Click Reset - shows confirm, resets, shows toast.</verify>
  <done>Share and Reset buttons are wired with toast feedback</done>
</task>

</tasks>

<verification>
1. Click Share button - "Copied!" toast appears
2. Paste clipboard - contains full URL with hash and ?view=readonly
3. Click Reset - confirmation dialog appears
4. Confirm Reset - moodboard changes to new template, toast appears
5. Press Cmd+Z after reset - previous state is restored (undoable)
6. Toasts appear at bottom-center with correct theming
</verification>

<success_criteria>
- [ ] Share button copies URL to clipboard
- [ ] "Copied!" toast appears on successful copy
- [ ] Share URL contains compressed state in hash
- [ ] Share URL includes ?view=readonly parameter
- [ ] Reset shows confirmation dialog
- [ ] Reset can be undone with Cmd+Z
- [ ] Toasts are styled to match app theme
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflows/06-03-SUMMARY.md`
</output>
